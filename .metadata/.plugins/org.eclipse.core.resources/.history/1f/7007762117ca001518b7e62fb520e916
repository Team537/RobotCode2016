#ifndef DRIVETRAIN_HPP
#define DRIVETRAIN_HPP

#include <Schematic.hpp>
#include <Shooter/ShooterManager.hpp>
#include <Vision/VisionManager.hpp>

class DriveTrain : public IComponent
{
	class VisionSource : public PIDSource
	{
	private:
		double center;
	public:
		VisionSource()
		{
			center = -1;
		}

		void SetPIDSourceType(PIDSourceType pidSource)
		{
			m_pidSource = pidSource;
		}

		void SetPIDCenter(double center)
		{
			this->center = center;
		}

		double PIDGet()
		{
			return center;
		}
	};

	class VisionOutput : public PIDOutput
	{
	private:
		float output;
	public:
		VisionOutput()
		{
			output = 0;
		}

		void PIDWrite(float output)
		{
			this->output = output;
		}

		float GetOutput()
		{
			return output;
		}
	};

	class SpinSource : public PIDSource
	{
	private:
		float targetAngle;
	public:
		SpinSource()
		{
			targetAngle = 0.0f;
		}

		void SetPIDSourceType(PIDSourceType pidSource)
		{
			m_pidSource = pidSource;
		}

		void SetTarget(float angle)
		{
			targetAngle = angle;
		}

		double PIDGet()
		{
			return angleGyro->GetAngle(); // TODO targetAngle
		}
	};

	class SpinOutput : public PIDOutput
	{
	private:
		float output;
	public:
		SpinOutput()
		{
			output = 0;
		}

		void PIDWrite(float output)
		{
			this->output = output;
		}

		float GetOutput()
		{
			return output;
		}
	};

private:
	CANTalon *rightDrive;
	CANTalon *leftDrive;
	Solenoid *shifter;
	AnalogGyro *angleGyro;
	ShooterManager *shooterManager;

	VisionSource *visionSource;
	VisionOutput *visionOutput;
	PIDController *visionPID;

	SpinSource *spinSource;
	SpinOutput *spinOutput;
	PIDController *spinPID;

	float currentSpeedLeft;
	float currentSpeedRight;
	float oldSpeedLeft;
	float oldSpeedRight;
	float deltaSpeedLeft;
	float deltaSpeedRight;
	float leftSign;
	float rightSign;
public:
	DriveTrain(Joystick *joystick, AnalogGyro *gyro, ShooterManager *shooter) : IComponent(joystick, new string("DriveTrain"))
	{
		rightDrive = new CANTalon(5);
		rightDrive->SetControlMode(CANTalon::ControlMode::kPercentVbus);
		rightDrive->SetFeedbackDevice(CANTalon::FeedbackDevice::QuadEncoder);
		rightDrive->EnableControl();

		leftDrive = new CANTalon(6);
		leftDrive->SetControlMode(CANTalon::ControlMode::kPercentVbus);
		leftDrive->SetFeedbackDevice(CANTalon::FeedbackDevice::QuadEncoder);
		leftDrive->EnableControl();

		shifter = new Solenoid(0);
		angleGyro = gyro;
		shooterManager = shooter;

		visionSource = new VisionSource();
		visionOutput = new VisionOutput();
		visionPID = new PIDController(1, 0, 0, visionSource, visionOutput);

		spinSource = new SpinSource();
		spinOutput = new SpinOutput();
		spinPID = new PIDController(1, 0, 0, spinSource, spinOutput);

		currentSpeedLeft = 0;
		currentSpeedRight = 0;
		oldSpeedLeft = 0;
		oldSpeedRight = 0;
		deltaSpeedLeft = 0;
		deltaSpeedRight = 0;
		leftSign = 1;
		rightSign = 1;
	}

	void Update();
	void Dashboard();

	void AutoAngle(float targetAngle);
};

#endif

